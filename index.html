<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Montage Builder Pro - Channel Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        body {
            background: #0f0f23;
            color: #ffffff;
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #4CAF50;
            text-align: center;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            padding: 0;
            margin: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            border: none;
            background: transparent;
            color: #ffffff;
            opacity: 0.7;
            position: relative;
        }

        .tab:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            opacity: 1;
            background: rgba(76, 175, 80, 0.1);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #4CAF50;
        }

        .tab-content {
            display: none;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 16px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #cccccc;
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-row label {
            margin-bottom: 0;
            min-width: 120px;
            font-size: 13px;
        }

        input[type="text"], 
        input[type="number"], 
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 13px;
        }

        select {
            cursor: pointer;
        }

        select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        input[type="text"]:focus, 
        input[type="number"]:focus, 
        select:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255, 255, 255, 0.15);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .info-panel {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-text {
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-line;
        }

        /* Каналы */
        .channel-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .channel-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .channel-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .channel-card.selected {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }

        .channel-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .channel-info {
            font-size: 11px;
            color: #999;
        }

        .channel-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .channel-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .channel-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Чекбоксы и радио */
        .checkbox-group,
        .radio-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        input[type="checkbox"],
        input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Слайдеры */
        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .slider-group label {
            min-width: 120px;
            margin-bottom: 0;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-size: 12px;
            color: #4CAF50;
            font-weight: 500;
        }

        /* Логи */
        .log-container {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
        }

        .log-info { color: #4CAF50; }
        .log-warning { color: #ff9800; }
        .log-error { color: #f44336; }

        /* Список эффектов с чекбоксами */
        .effects-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .effect-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #4CAF50;
            font-size: 20px;
            margin: 0;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Скроллбары */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.6);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.8);
        }

        /* Анимации */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .error {
            animation: shake 0.5s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 33.333%;
            }
            
            .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-row label {
                min-width: auto;
                margin-bottom: 5px;
            }
        }

        /* Плавающая кнопка отмены */
        .cancel-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .cancel-button.show {
            display: flex;
        }

        .cancel-button:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        /* Теги для эффектов */
        .tag {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            border-radius: 16px;
            font-size: 11px;
            margin: 2px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 AUTO MONTAGE BUILDER PRO - CHANNEL EDITION</h1>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="generation">🎬 Генерация</button>
            <button class="tab" data-tab="channels">📺 Каналы</button>
            <button class="tab" data-tab="effects">🎨 Эффекты</button>
            <button class="tab" data-tab="settings">⚙️ Настройки</button>
        </div>

        <!-- Вкладка Генерация -->
        <div class="tab-content active" id="generation">
            <div class="panel">
                <h3>📁 Папка проекта</h3>
                <div class="form-row">
                    <input type="text" id="projectPath" placeholder="Выберите папку с изображениями и аудио" readonly>
                    <button class="btn btn-secondary" onclick="selectProjectFolder()">Обзор...</button>
                </div>
            </div>

            <div class="info-panel">
                <div class="info-text" id="projectInfo">Выберите папку проекта для начала работы</div>
            </div>

            <div class="panel">
                <h3>📺 Выбор каналов для генерации</h3>
                <div class="channel-list" id="generationChannelList">
                    <!-- Динамически генерируется -->
                </div>
                <div class="info-text" style="margin-top: 10px; font-size: 12px; color: #999;">
                    Выберите каналы, для которых нужно создать видео. Каждый канал создаст свой уникальный вариант.
                </div>
            </div>

            <div class="panel">
                <h3>📤 Настройки экспорта</h3>
                <div class="form-row">
                    <label>Режим экспорта:</label>
                    <select id="exportMode">
                        <option value="timeline">Оставить на таймлайне</option>
                        <option value="auto">Автоматический экспорт через Media Encoder</option>
                        <option value="manual">Добавить в очередь Media Encoder</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Формат файлов:</label>
                    <select id="outputFormat">
                        <option value="h264">H.264 (универсальный)</option>
                        <option value="h265">H.265/HEVC (меньший размер)</option>
                        <option value="prores">ProRes (высокое качество)</option>
                    </select>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="importFiles()">📂 Импорт файлов</button>
                <button class="btn btn-primary" onclick="generateMontage()" id="generateBtn">
                    🎬 СОЗДАТЬ МОНТАЖ
                </button>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">Готов к работе</div>
                </div>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">Система готова к работе</div>
            </div>
        </div>

        <!-- Вкладка Каналы -->
        <div class="tab-content" id="channels">
            <div class="panel">
                <h3>📺 Управление каналами</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="createChannel()">➕ Создать канал</button>
                    <button class="btn btn-secondary" onclick="importChannels()">📥 Импорт</button>
                    <button class="btn btn-secondary" onclick="exportChannels()">📤 Экспорт</button>
                </div>
            </div>

            <div class="panel">
                <h3>📋 Список каналов</h3>
                <div class="channel-list" id="channelList">
                    <!-- Динамически генерируется -->
                </div>
            </div>
        </div>

        <!-- Вкладка Эффекты -->
        <div class="tab-content" id="effects">
            <div class="info-panel">
                <div class="info-text">
                    Выберите канал для редактирования его эффектов
                </div>
            </div>

            <div class="panel">
                <h3>📺 Текущий канал: <span id="currentChannelName">Не выбран</span></h3>
                <select id="channelSelector" onchange="loadChannelEffects()">
                    <option value="">Выберите канал...</option>
                </select>
            </div>

            <div id="effectsEditor" style="display: none;">
                <!-- Ken Burns эффекты -->
                <div class="panel">
                    <h3>🎬 Ken Burns эффекты</h3>
                    <div class="effects-list">
                        <div class="effect-item">
                            <input type="checkbox" id="kb_zoomIn" class="kb-effect">
                            <label for="kb_zoomIn">Zoom In (приближение)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="kb_zoomOut" class="kb-effect">
                            <label for="kb_zoomOut">Zoom Out (отдаление)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="kb_panLeft" class="kb-effect">
                            <label for="kb_panLeft">Pan Left (движение влево)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="kb_panRight" class="kb-effect">
                            <label for="kb_panRight">Pan Right (движение вправо)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="kb_panUp" class="kb-effect">
                            <label for="kb_panUp">Pan Up (движение вверх)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="kb_panDown" class="kb-effect">
                            <label for="kb_panDown">Pan Down (движение вниз)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="kb_rotate" class="kb-effect">
                            <label for="kb_rotate">Rotate (вращение)</label>
                        </div>
                    </div>
                    
                    <div class="slider-group">
                        <label>Интенсивность:</label>
                        <input type="range" id="kbIntensity" class="slider" min="0" max="100" value="30">
                        <span class="slider-value" id="kbIntensityValue">30%</span>
                    </div>
                    
                    <div class="slider-group">
                        <label>Угол вращения:</label>
                        <input type="range" id="rotationAngle" class="slider" min="0" max="30" value="5">
                        <span class="slider-value" id="rotationAngleValue">5°</span>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="kbSmartCrop" checked>
                        <label for="kbSmartCrop">Умная обрезка (предотвращает появление черных полос)</label>
                    </div>
                </div>

                <!-- Анимации масштаба -->
                <div class="panel">
                    <h3>🔍 Анимации масштаба</h3>
                    <div class="effects-list">
                        <div class="effect-item">
                            <input type="checkbox" id="scale_pulse" class="scale-effect">
                            <label for="scale_pulse">Pulse (пульсация)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="scale_bounce" class="scale-effect">
                            <label for="scale_bounce">Bounce (прыжок)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="scale_elastic" class="scale-effect">
                            <label for="scale_elastic">Elastic (эластичный)</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="scale_smooth" class="scale-effect">
                            <label for="scale_smooth">Smooth (плавный)</label>
                        </div>
                    </div>
                    
                    <div class="slider-group">
                        <label>Амплитуда:</label>
                        <input type="range" id="scaleAmplitude" class="slider" min="0" max="50" value="10">
                        <span class="slider-value" id="scaleAmplitudeValue">10%</span>
                    </div>
                </div>

                <!-- Переходы -->
                <div class="panel">
                    <h3>🔄 Переходы</h3>
                    <div class="effects-list">
                        <div class="effect-item">
                            <input type="checkbox" id="trans_fade" class="transition-effect">
                            <label for="trans_fade">Fade</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="trans_dissolve" class="transition-effect">
                            <label for="trans_dissolve">Cross Dissolve</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="trans_dip_black" class="transition-effect">
                            <label for="trans_dip_black">Dip to Black</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="trans_dip_white" class="transition-effect">
                            <label for="trans_dip_white">Dip to White</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="trans_wipe" class="transition-effect">
                            <label for="trans_wipe">Wipe</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="trans_slide" class="transition-effect">
                            <label for="trans_slide">Slide</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="trans_push" class="transition-effect">
                            <label for="trans_push">Push</label>
                        </div>
                        <div class="effect-item">
                            <input type="checkbox" id="trans_zoom" class="transition-effect">
                            <label for="trans_zoom">Zoom</label>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label>Длительность:</label>
                        <input type="number" id="transitionDuration" value="1.0" min="0.1" max="3.0" step="0.1" style="width: 100px;">
                        <span>секунд</span>
                    </div>
                </div>

                <!-- Цветокоррекция -->
                <div class="panel">
                    <h3>🎨 Цветокоррекция и фильтры</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableColorCorrection">
                        <label for="enableColorCorrection">Включить цветокоррекцию</label>
                    </div>
                    
                    <div id="colorCorrectionSettings" style="display: none;">
                        <div class="form-row">
                            <label>Фильтр:</label>
                            <select id="colorFilter">
                                <option value="none">Без фильтра</option>
                                <option value="warm">Теплый</option>
                                <option value="cold">Холодный</option>
                                <option value="vintage">Винтаж</option>
                                <option value="blackwhite">Черно-белый</option>
                                <option value="sepia">Сепия</option>
                                <option value="cinematic">Кинематографичный</option>
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableVignette">
                            <label for="enableVignette">Виньетка</label>
                        </div>
                        
                        <div class="slider-group" id="vignetteSettings" style="display: none;">
                            <label>Интенсивность:</label>
                            <input type="range" id="vignetteIntensity" class="slider" min="0" max="100" value="40">
                            <span class="slider-value" id="vignetteIntensityValue">40%</span>
                        </div>
                    </div>
                </div>

                <!-- Аудио настройки -->
                <div class="panel">
                    <h3>🎵 Аудио настройки</h3>
                    <div class="form-row">
                        <label>Тональность (Pitch):</label>
                        <select id="audioPitch">
                            <option value="-3">-3 (очень низкий)</option>
                            <option value="-2">-2 (низкий)</option>
                            <option value="-1.5">-1.5</option>
                            <option value="-1">-1</option>
                            <option value="-0.5">-0.5</option>
                            <option value="0" selected>0 (оригинал)</option>
                            <option value="+0.5">+0.5</option>
                            <option value="+1">+1</option>
                            <option value="+1.5">+1.5</option>
                            <option value="+2">+2 (высокий)</option>
                            <option value="+3">+3 (очень высокий)</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <label>Эффект:</label>
                        <select id="audioEffect">
                            <option value="none">Без эффекта</option>
                            <option value="bass">Усиление басов</option>
                            <option value="reverb">Реверберация</option>
                            <option value="echo">Эхо</option>
                            <option value="chorus">Хорус</option>
                            <option value="telephone">Телефон</option>
                            <option value="underwater">Под водой</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="audioStereoEnhance">
                        <label for="audioStereoEnhance">Расширение стерео</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="audioNormalize" checked>
                        <label for="audioNormalize">Нормализация громкости</label>
                    </div>
                </div>

                <!-- Плавность анимации -->
                <div class="panel">
                    <h3>⚡ Плавность анимации</h3>
                    <div class="form-row">
                        <label>Тип интерполяции:</label>
                        <select id="easingType">
                            <option value="linear">Линейная</option>
                            <option value="ease" selected>Плавная</option>
                            <option value="ease-in">Ускорение</option>
                            <option value="ease-out">Замедление</option>
                            <option value="ease-in-out">Ускорение и замедление</option>
                            <option value="bezier">Кривая Безье</option>
                        </select>
                    </div>
                    
                    <div id="bezierSettings" style="display: none;">
                        <div class="slider-group">
                            <label>Контрольная точка 1:</label>
                            <input type="range" id="bezierP1" class="slider" min="0" max="100" value="25">
                            <span class="slider-value" id="bezierP1Value">25</span>
                        </div>
                        <div class="slider-group">
                            <label>Контрольная точка 2:</label>
                            <input type="range" id="bezierP2" class="slider" min="0" max="100" value="75">
                            <span class="slider-value" id="bezierP2Value">75</span>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveChannelEffects()">💾 Сохранить настройки канала</button>
                    <button class="btn btn-secondary" onclick="resetChannelEffects()">🔄 Сбросить</button>
                    <button class="btn btn-secondary" onclick="previewEffects()">👁️ Предпросмотр</button>
                </div>
            </div>
        </div>

        <!-- Вкладка Настройки -->
        <div class="tab-content" id="settings">
            <div class="panel">
                <h3>📁 Пути к программам</h3>
                <div class="form-group">
                    <label>FFmpeg:</label>
                    <div class="form-row">
                        <input type="text" id="ffmpegPath" value="ffmpeg.exe">
                        <button class="btn btn-secondary" onclick="browsePath('ffmpeg')">...</button>
                    </div>
                    <div class="info-text" style="font-size: 11px; color: #999; margin-top: 5px;">
                        Используется для обработки аудио. Скачать: https://ffmpeg.org/download.html
                    </div>
                </div>
                <div class="form-group">
                    <label>Media Encoder:</label>
                    <div class="form-row">
                        <input type="text" id="amePath" value="">
                        <button class="btn btn-secondary" onclick="browsePath('ame')">...</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>⚡ Производительность</h3>
                <div class="slider-group">
                    <label>Потоки рендеринга:</label>
                    <input type="range" id="renderThreads" class="slider" min="1" max="16" value="4">
                    <span class="slider-value" id="renderThreadsValue">4</span>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="useGPU" checked>
                    <label for="useGPU">Использовать GPU ускорение</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="useProxies">
                    <label for="useProxies">Создавать прокси для 4K видео</label>
                </div>
            </div>

            <div class="panel">
                <h3>🌐 Обработка путей</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="transcodeRussian" checked>
                    <label for="transcodeRussian">Автоматически перекодировать русские названия файлов</label>
                </div>
                <div class="info-text" style="font-size: 11px; color: #999; margin-top: 10px;">
                    FFmpeg может некорректно работать с русскими символами в путях. 
                    Эта опция автоматически создаст временные копии с английскими именами.
                </div>
            </div>

            <div class="panel">
                <h3>🎯 Настройки по умолчанию</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="autoSave" checked>
                    <label for="autoSave">Автосохранение проекта каждые 5 минут</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="keepSourceAudio" checked>
                    <label for="keepSourceAudio">Сохранять оригинальные аудио файлы</label>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveSettings()">💾 Сохранить настройки</button>
                <button class="btn btn-secondary" onclick="resetSettings()">🔄 Сбросить</button>
            </div>

            <div class="panel" style="margin-top: 30px;">
                <h3>ℹ️ О программе</h3>
                <div class="info-text">
                    <strong>Auto Montage Builder Pro - Channel Edition</strong><br>
                    Версия: 3.0.0<br>
                    Оптимизировано для Adobe Premiere Pro 2020+<br><br>
                    
                    <strong>Новые возможности:</strong><br>
                    • Система каналов для YouTube<br>
                    • Продвинутые Ken Burns эффекты с защитой от черных полос<br>
                    • Множественные анимации масштаба<br>
                    • Рандомизация эффектов<br>
                    • Умная обработка русских имен файлов<br>
                    • Кривые Безье для плавности анимации
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания канала -->
    <div class="modal" id="channelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Создание нового канала</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название канала:</label>
                    <input type="text" id="newChannelName" placeholder="Например: Мой основной канал">
                </div>
                <div class="form-group">
                    <label>Описание:</label>
                    <input type="text" id="newChannelDescription" placeholder="Краткое описание канала">
                </div>
                <div class="form-group">
                    <label>Шаблон экспорта:</label>
                    <select id="newChannelTemplate">
                        <option value="YouTube">YouTube (1920x1080)</option>
                        <option value="YouTube Shorts">YouTube Shorts (1080x1920)</option>
                        <option value="TikTok">TikTok (1080x1920)</option>
                        <option value="Instagram Reels">Instagram Reels (1080x1920)</option>
                        <option value="Instagram Feed">Instagram Feed (1080x1080)</option>
                        <option value="Twitter">Twitter (1280x720)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('channelModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveNewChannel()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Кнопка отмены -->
    <button class="cancel-button" id="cancelButton" onclick="cancelGeneration()">✕</button>

    <script>
        // Глобальные переменные
        let PROJECT_FOLDER = null;
        let AUDIO_VARIANTS_FOLDER = null;
        let RENDERS_FOLDER = null;
        let channels = [];
        let selectedChannels = new Set();
        let currentChannelId = null;
        let isGenerating = false;
        let generationAborted = false;

        // Константы
        const EXPORT_PRESETS = {
            'YouTube': { width: 1920, height: 1080, bitrate: 8000, fps: 30 },
            'YouTube Shorts': { width: 1080, height: 1920, bitrate: 10000, fps: 30 },
            'TikTok': { width: 1080, height: 1920, bitrate: 6000, fps: 30 },
            'Instagram Reels': { width: 1080, height: 1920, bitrate: 8000, fps: 30 },
            'Instagram Feed': { width: 1080, height: 1080, bitrate: 6000, fps: 30 },
            'Twitter': { width: 1280, height: 720, bitrate: 5000, fps: 30 }
        };

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            loadChannels();
            loadSettings();
            setupEventListeners();
            
            // Проверяем CEP окружение
            if (typeof CSInterface !== 'undefined') {
                const csInterface = new CSInterface();
                log('CEP интерфейс инициализирован', 'info');
            } else {
                log('Работа в режиме предпросмотра', 'warning');
            }
        });

        // Управление вкладками
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // Настройка слушателей событий
        function setupEventListeners() {
            // Слайдеры
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const valueSpan = document.getElementById(this.id + 'Value');
                    if (valueSpan) {
                        let value = this.value;
                        if (this.id.includes('Angle')) {
                            value += '°';
                        } else if (this.id !== 'renderThreads' && this.id !== 'bezierP1' && this.id !== 'bezierP2') {
                            value += '%';
                        }
                        valueSpan.textContent = value;
                    }
                });
            });

            // Чекбоксы
            document.getElementById('enableColorCorrection').addEventListener('change', function() {
                document.getElementById('colorCorrectionSettings').style.display = 
                    this.checked ? 'block' : 'none';
            });

            document.getElementById('enableVignette').addEventListener('change', function() {
                document.getElementById('vignetteSettings').style.display = 
                    this.checked ? 'block' : 'none';
            });

            document.getElementById('easingType').addEventListener('change', function() {
                document.getElementById('bezierSettings').style.display = 
                    this.value === 'bezier' ? 'block' : 'none';
            });
        }

        // Логирование
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Обновление прогресса
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // === РАБОТА С ПАПКОЙ ПРОЕКТА ===
        
        function selectProjectFolder() {
            if (typeof CSInterface !== 'undefined') {
                const csInterface = new CSInterface();
                
                const extScript = `
                    var folder = Folder.selectDialog("Выберите папку проекта с изображениями и аудио");
                    if (folder) {
                        folder.fsName;
                    } else {
                        null;
                    }
                `;
                
                csInterface.evalScript(extScript, function(result) {
                    if (result && result !== 'null') {
                        PROJECT_FOLDER = result;
                        document.getElementById('projectPath').value = result;
                        
                        AUDIO_VARIANTS_FOLDER = PROJECT_FOLDER + "/audio_variants";
                        RENDERS_FOLDER = PROJECT_FOLDER + "/renders";
                        
                        createSubfolders();
                        scanProjectFolder();
                    }
                });
            } else {
                // Режим симуляции
                PROJECT_FOLDER = "C:/TestProject";
                document.getElementById('projectPath').value = PROJECT_FOLDER;
                AUDIO_VARIANTS_FOLDER = PROJECT_FOLDER + "/audio_variants";
                RENDERS_FOLDER = PROJECT_FOLDER + "/renders";
                
                updateProjectInfo({
                    images: 5,
                    audio: 5,
                    pairs: 5
                });
            }
        }

        function createSubfolders() {
            if (!PROJECT_FOLDER) return;
            
            const extScript = `
                var audioVariantsDir = new Folder("${AUDIO_VARIANTS_FOLDER.replace(/\\/g, '\\\\')}");
                if (!audioVariantsDir.exists) audioVariantsDir.create();
                
                var rendersDir = new Folder("${RENDERS_FOLDER.replace(/\\/g, '\\\\')}");
                if (!rendersDir.exists) rendersDir.create();
                
                "Подпапки созданы";
            `;
            
            if (typeof CSInterface !== 'undefined') {
                const csInterface = new CSInterface();
                csInterface.evalScript(extScript, function(result) {
                    log('Подпапки проекта созданы', 'info');
                });
            }
        }

        function scanProjectFolder() {
            if (!PROJECT_FOLDER) return;
            
            updateProgress(10, "Сканирование папки...");
            
            const extScript = `
                function scanFolder(folderPath) {
                    try {
                        var folder = new Folder(folderPath);
                        if (!folder.exists) {
                            return {images: 0, audio: 0, pairs: 0, error: "Папка не существует"};
                        }
                        
                        var images = 0;
                        var audio = 0;
                        var pairs = [];
                        var imageFiles = {};
                        var audioFiles = {};
                        
                        var files = folder.getFiles();
                        var supportedImageFormats = ['.jpg', '.jpeg', '.png', '.tiff', '.bmp', '.tif'];
                        var supportedAudioFormats = ['.mp3', '.wav', '.aiff', '.m4a', '.flac'];
                        
                        // Сканируем файлы
                        for (var i = 0; i < files.length; i++) {
                            if (files[i] instanceof File) {
                                var fileName = files[i].name;
                                var ext = fileName.substr(fileName.lastIndexOf('.')).toLowerCase();
                                var baseNumber = fileName.match(/^(\\d{4})/);
                                
                                if (supportedImageFormats.indexOf(ext) > -1) {
                                    images++;
                                    if (baseNumber) imageFiles[baseNumber[1]] = true;
                                } else if (supportedAudioFormats.indexOf(ext) > -1) {
                                    audio++;
                                    if (baseNumber) audioFiles[baseNumber[1]] = true;
                                }
                            }
                        }
                        
                        // Считаем пары
                        for (var num in imageFiles) {
                            if (audioFiles[num]) {
                                pairs.push(num);
                            }
                        }
                        
                        return {
                            images: images,
                            audio: audio,
                            pairs: pairs.length
                        };
                        
                    } catch(e) {
                        return {images: 0, audio: 0, pairs: 0, error: e.toString()};
                    }
                }
                
                JSON.stringify(scanFolder("${PROJECT_FOLDER.replace(/\\/g, '\\\\')}"));
            `;
            
            if (typeof CSInterface !== 'undefined') {
                const csInterface = new CSInterface();
                csInterface.evalScript(extScript, function(result) {
                    try {
                        const scanResult = JSON.parse(result);
                        updateProgress(0, "Готов к работе");
                        updateProjectInfo(scanResult);
                    } catch(e) {
                        log('Ошибка сканирования: ' + e.message, 'error');
                    }
                });
            }
        }

        function updateProjectInfo(scanResult) {
            let info = "📊 Результаты сканирования:\n\n";
            info += `✅ Изображений: ${scanResult.images}\n`;
            info += `✅ Аудио файлов: ${scanResult.audio}\n`;
            info += `✅ Готовых пар: ${scanResult.pairs}`;
            
            if (scanResult.error) {
                info += `\n\n⚠️ Ошибка: ${scanResult.error}`;
            }
            
            document.getElementById('projectInfo').textContent = info;
            log(`Найдено пар файлов: ${scanResult.pairs}`, 'info');
        }

        // === РАБОТА С КАНАЛАМИ ===

        function loadChannels() {
            const stored = localStorage.getItem('autoMontageChannels');
            if (stored) {
                try {
                    channels = JSON.parse(stored);
                } catch(e) {
                    channels = getDefaultChannels();
                }
            } else {
                channels = getDefaultChannels();
            }
            
            updateChannelLists();
        }

        function getDefaultChannels() {
            return [
                {
                    id: 'channel_1',
                    name: 'Основной канал',
                    description: 'Мой главный YouTube канал',
                    template: 'YouTube',
                    effects: {
                        kenBurns: ['zoomIn', 'panRight'],
                        kenBurnsIntensity: 30,
                        rotationAngle: 5,
                        smartCrop: true,
                        scaleEffects: ['smooth'],
                        scaleAmplitude: 10,
                        transitions: ['fade', 'dissolve'],
                        transitionDuration: 1.0,
                        colorCorrection: true,
                        colorFilter: 'warm',
                        vignette: true,
                        vignetteIntensity: 40,
                        audioPitch: '-0.5',
                        audioEffect: 'bass',
                        audioStereoEnhance: true,
                        audioNormalize: true,
                        easingType: 'ease',
                        bezierP1: 25,
                        bezierP2: 75
                    }
                },
                {
                    id: 'channel_2',
                    name: 'Shorts канал',
                    description: 'Канал для коротких видео',
                    template: 'YouTube Shorts',
                    effects: {
                        kenBurns: ['zoomOut', 'panUp'],
                        kenBurnsIntensity: 50,
                        rotationAngle: 10,
                        smartCrop: true,
                        scaleEffects: ['bounce'],
                        scaleAmplitude: 15,
                        transitions: ['zoom', 'slide'],
                        transitionDuration: 0.5,
                        colorCorrection: true,
                        colorFilter: 'cinematic',
                        vignette: false,
                        vignetteIntensity: 0,
                        audioPitch: '+1',
                        audioEffect: 'reverb',
                        audioStereoEnhance: false,
                        audioNormalize: true,
                        easingType: 'ease-in-out',
                        bezierP1: 25,
                        bezierP2: 75
                    }
                }
            ];
        }

        function saveChannels() {
            localStorage.setItem('autoMontageChannels', JSON.stringify(channels));
        }

        function updateChannelLists() {
            // Обновляем список каналов на вкладке управления
            const channelList = document.getElementById('channelList');
            channelList.innerHTML = '';
            
            channels.forEach(channel => {
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.innerHTML = `
                    <div class="channel-name">${channel.name}</div>
                    <div class="channel-info">${channel.description}</div>
                    <div class="channel-info">Шаблон: ${channel.template}</div>
                    <div class="channel-actions">
                        <button class="channel-action-btn" onclick="editChannel('${channel.id}')" title="Редактировать">✏️</button>
                        <button class="channel-action-btn" onclick="duplicateChannel('${channel.id}')" title="Дублировать">📋</button>
                        <button class="channel-action-btn" onclick="deleteChannel('${channel.id}')" title="Удалить">🗑️</button>
                    </div>
                `;
                channelList.appendChild(card);
            });
            
            // Обновляем список для генерации
            const genChannelList = document.getElementById('generationChannelList');
            genChannelList.innerHTML = '';
            
            channels.forEach(channel => {
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.onclick = () => toggleChannelSelection(channel.id);
                card.innerHTML = `
                    <div class="channel-name">${channel.name}</div>
                    <div class="channel-info">${channel.template}</div>
                `;
                if (selectedChannels.has(channel.id)) {
                    card.classList.add('selected');
                }
                genChannelList.appendChild(card);
            });
            
            // Обновляем селектор каналов в эффектах
            const channelSelector = document.getElementById('channelSelector');
            channelSelector.innerHTML = '<option value="">Выберите канал...</option>';
            
            channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = channel.name;
                channelSelector.appendChild(option);
            });
        }

        function toggleChannelSelection(channelId) {
            if (selectedChannels.has(channelId)) {
                selectedChannels.delete(channelId);
            } else {
                selectedChannels.add(channelId);
            }
            updateChannelLists();
        }

        function createChannel() {
            document.getElementById('channelModal').classList.add('show');
        }

        function saveNewChannel() {
            const name = document.getElementById('newChannelName').value.trim();
            const description = document.getElementById('newChannelDescription').value.trim();
            const template = document.getElementById('newChannelTemplate').value;
            
            if (!name) {
                alert('Введите название канала!');
                return;
            }
            
            const newChannel = {
                id: 'channel_' + Date.now(),
                name: name,
                description: description,
                template: template,
                effects: {
                    kenBurns: [],
                    kenBurnsIntensity: 30,
                    rotationAngle: 5,
                    smartCrop: true,
                    scaleEffects: [],
                    scaleAmplitude: 10,
                    transitions: ['fade'],
                    transitionDuration: 1.0,
                    colorCorrection: false,
                    colorFilter: 'none',
                    vignette: false,
                    vignetteIntensity: 40,
                    audioPitch: '0',
                    audioEffect: 'none',
                    audioStereoEnhance: false,
                    audioNormalize: true,
                    easingType: 'ease',
                    bezierP1: 25,
                    bezierP2: 75
                }
            };
            
            channels.push(newChannel);
            saveChannels();
            updateChannelLists();
            closeModal('channelModal');
            log(`Создан новый канал: ${name}`, 'info');
        }

        function editChannel(channelId) {
            // Переключаемся на вкладку эффектов
            document.querySelector('[data-tab="effects"]').click();
            
            // Выбираем канал
            document.getElementById('channelSelector').value = channelId;
            loadChannelEffects();
        }

        function duplicateChannel(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            const newChannel = JSON.parse(JSON.stringify(channel));
            newChannel.id = 'channel_' + Date.now();
            newChannel.name = channel.name + ' (копия)';
            
            channels.push(newChannel);
            saveChannels();
            updateChannelLists();
            log(`Канал "${channel.name}" дублирован`, 'info');
        }

        function deleteChannel(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            if (confirm(`Удалить канал "${channel.name}"?`)) {
                channels = channels.filter(c => c.id !== channelId);
                saveChannels();
                updateChannelLists();
                log(`Канал "${channel.name}" удален`, 'info');
            }
        }

        // === РАБОТА С ЭФФЕКТАМИ ===

        function loadChannelEffects() {
            const channelId = document.getElementById('channelSelector').value;
            if (!channelId) {
                document.getElementById('effectsEditor').style.display = 'none';
                return;
            }
            
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            currentChannelId = channelId;
            document.getElementById('currentChannelName').textContent = channel.name;
            document.getElementById('effectsEditor').style.display = 'block';
            
            // Загружаем настройки
            const effects = channel.effects;
            
            // Ken Burns
            document.querySelectorAll('.kb-effect').forEach(cb => {
                const effectName = cb.id.replace('kb_', '');
                cb.checked = effects.kenBurns && effects.kenBurns.includes(effectName);
            });
            document.getElementById('kbIntensity').value = effects.kenBurnsIntensity || 30;
            document.getElementById('kbIntensityValue').textContent = (effects.kenBurnsIntensity || 30) + '%';
            document.getElementById('rotationAngle').value = effects.rotationAngle || 5;
            document.getElementById('rotationAngleValue').textContent = (effects.rotationAngle || 5) + '°';
            document.getElementById('kbSmartCrop').checked = effects.smartCrop !== false;
            
            // Scale эффекты
            document.querySelectorAll('.scale-effect').forEach(cb => {
                const effectName = cb.id.replace('scale_', '');
                cb.checked = effects.scaleEffects && effects.scaleEffects.includes(effectName);
            });
            document.getElementById('scaleAmplitude').value = effects.scaleAmplitude || 10;
            document.getElementById('scaleAmplitudeValue').textContent = (effects.scaleAmplitude || 10) + '%';
            
            // Переходы
            document.querySelectorAll('.transition-effect').forEach(cb => {
                const effectName = cb.id.replace('trans_', '');
                cb.checked = effects.transitions && effects.transitions.includes(effectName);
            });
            document.getElementById('transitionDuration').value = effects.transitionDuration || 1.0;
            
            // Цветокоррекция
            document.getElementById('enableColorCorrection').checked = effects.colorCorrection || false;
            document.getElementById('colorCorrectionSettings').style.display = effects.colorCorrection ? 'block' : 'none';
            document.getElementById('colorFilter').value = effects.colorFilter || 'none';
            document.getElementById('enableVignette').checked = effects.vignette || false;
            document.getElementById('vignetteSettings').style.display = effects.vignette ? 'block' : 'none';
            document.getElementById('vignetteIntensity').value = effects.vignetteIntensity || 40;
            document.getElementById('vignetteIntensityValue').textContent = (effects.vignetteIntensity || 40) + '%';
            
            // Аудио
            document.getElementById('audioPitch').value = effects.audioPitch || '0';
            document.getElementById('audioEffect').value = effects.audioEffect || 'none';
            document.getElementById('audioStereoEnhance').checked = effects.audioStereoEnhance || false;
            document.getElementById('audioNormalize').checked = effects.audioNormalize !== false;
            
            // Плавность
            document.getElementById('easingType').value = effects.easingType || 'ease';
            document.getElementById('bezierSettings').style.display = effects.easingType === 'bezier' ? 'block' : 'none';
            document.getElementById('bezierP1').value = effects.bezierP1 || 25;
            document.getElementById('bezierP1Value').textContent = effects.bezierP1 || 25;
            document.getElementById('bezierP2').value = effects.bezierP2 || 75;
            document.getElementById('bezierP2Value').textContent = effects.bezierP2 || 75;
        }

        function saveChannelEffects() {
            if (!currentChannelId) return;
            
            const channel = channels.find(c => c.id === currentChannelId);
            if (!channel) return;
            
            // Собираем все настройки
            const effects = {
                kenBurns: [],
                kenBurnsIntensity: parseInt(document.getElementById('kbIntensity').value),
                rotationAngle: parseInt(document.getElementById('rotationAngle').value),
                smartCrop: document.getElementById('kbSmartCrop').checked,
                scaleEffects: [],
                scaleAmplitude: parseInt(document.getElementById('scaleAmplitude').value),
                transitions: [],
                transitionDuration: parseFloat(document.getElementById('transitionDuration').value),
                colorCorrection: document.getElementById('enableColorCorrection').checked,
                colorFilter: document.getElementById('colorFilter').value,
                vignette: document.getElementById('enableVignette').checked,
                vignetteIntensity: parseInt(document.getElementById('vignetteIntensity').value),
                audioPitch: document.getElementById('audioPitch').value,
                audioEffect: document.getElementById('audioEffect').value,
                audioStereoEnhance: document.getElementById('audioStereoEnhance').checked,
                audioNormalize: document.getElementById('audioNormalize').checked,
                easingType: document.getElementById('easingType').value,
                bezierP1: parseInt(document.getElementById('bezierP1').value),
                bezierP2: parseInt(document.getElementById('bezierP2').value)
            };
            
            // Собираем выбранные эффекты
            document.querySelectorAll('.kb-effect:checked').forEach(cb => {
                effects.kenBurns.push(cb.id.replace('kb_', ''));
            });
            
            document.querySelectorAll('.scale-effect:checked').forEach(cb => {
                effects.scaleEffects.push(cb.id.replace('scale_', ''));
            });
            
            document.querySelectorAll('.transition-effect:checked').forEach(cb => {
                effects.transitions.push(cb.id.replace('trans_', ''));
            });
            
            // Сохраняем
            channel.effects = effects;
            saveChannels();
            log(`Настройки канала "${channel.name}" сохранены`, 'info');
        }

        function resetChannelEffects() {
            if (!currentChannelId) return;
            
            if (confirm('Сбросить все настройки эффектов к значениям по умолчанию?')) {
                const channel = channels.find(c => c.id === currentChannelId);
                if (!channel) return;
                
                channel.effects = {
                    kenBurns: [],
                    kenBurnsIntensity: 30,
                    rotationAngle: 5,
                    smartCrop: true,
                    scaleEffects: [],
                    scaleAmplitude: 10,
                    transitions: ['fade'],
                    transitionDuration: 1.0,
                    colorCorrection: false,
                    colorFilter: 'none',
                    vignette: false,
                    vignetteIntensity: 40,
                    audioPitch: '0',
                    audioEffect: 'none',
                    audioStereoEnhance: false,
                    audioNormalize: true,
                    easingType: 'ease',
                    bezierP1: 25,
                    bezierP2: 75
                };
                
                saveChannels();
                loadChannelEffects();
                log('Настройки сброшены', 'info');
            }
        }

        function previewEffects() {
            alert('Предпросмотр будет реализован в следующей версии');
        }

        // === ИМПОРТ/ЭКСПОРТ КАНАЛОВ ===

        function exportChannels() {
            const dataStr = JSON.stringify(channels, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'automontage_channels_' + new Date().toISOString().slice(0, 10) + '.json';
            link.click();
            
            log('Каналы экспортированы', 'info');
        }

        function importChannels() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedChannels = JSON.parse(event.target.result);
                        
                        if (Array.isArray(importedChannels)) {
                            channels = importedChannels;
                            saveChannels();
                            updateChannelLists();
                            log('Каналы импортированы успешно', 'info');
                        } else {
                            throw new Error('Неверный формат файла');
                        }
                    } catch (err) {
                        alert('Ошибка импорта: ' + err.message);
                        log('Ошибка импорта каналов', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // === ГЕНЕРАЦИЯ МОНТАЖА ===

        function importFiles() {
            if (!PROJECT_FOLDER) {
                alert("Сначала выберите папку проекта!");
                return;
            }
            
            updateProgress(0, "Импорт файлов...");
            log("Начинаем импорт файлов в проект", 'info');
            
            const extScript = `
                function importProjectFiles(folderPath) {
                    try {
                        var project = app.project;
                        if (!project) return "ERROR: Нет активного проекта";
                        
                        var folder = new Folder(folderPath);
                        if (!folder.exists) return "ERROR: Папка не существует";
                        
                        var importBin = project.rootItem.createBin("Auto Montage Import " + new Date().toLocaleString());
                        var files = folder.getFiles();
                        var importedCount = 0;
                        
                        var supportedFormats = ['.jpg', '.jpeg', '.png', '.tiff', '.bmp', '.mp3', '.wav', '.aiff', '.m4a'];
                        
                        for (var i = 0; i < files.length; i++) {
                            if (files[i] instanceof File) {
                                var ext = files[i].name.substr(files[i].name.lastIndexOf('.')).toLowerCase();
                                if (supportedFormats.indexOf(ext) > -1) {
                                    project.importFiles([files[i].fsName], false, importBin, false);
                                    importedCount++;
                                }
                            }
                        }
                        
                        return "SUCCESS: Импортировано " + importedCount + " файлов";
                        
                    } catch(e) {
                        return "ERROR: " + e.toString();
                    }
                }
                
                importProjectFiles("${PROJECT_FOLDER.replace(/\\/g, '\\\\')}");
            `;
            
            if (typeof CSInterface !== 'undefined') {
                const csInterface = new CSInterface();
                csInterface.evalScript(extScript, function(result) {
                    if (result.indexOf("SUCCESS") === 0) {
                        updateProgress(100, "Файлы импортированы");
                        log(result, 'info');
                    } else {
                        updateProgress(0, "Ошибка импорта");
                        log(result, 'error');
                    }
                });
            } else {
                setTimeout(() => {
                    updateProgress(100, "Файлы импортированы (симуляция)");
                    log("Импортировано 10 файлов (симуляция)", 'info');
                }, 1500);
            }
        }

        async function generateMontage() {
            if (!PROJECT_FOLDER) {
                alert("Сначала выберите папку проекта!");
                return;
            }
            
            if (selectedChannels.size === 0) {
                alert("Выберите хотя бы один канал для генерации!");
                return;
            }
            
            isGenerating = true;
            generationAborted = false;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('cancelButton').classList.add('show');
            
            log(`Начинаем генерацию для ${selectedChannels.size} каналов`, 'info');
            
            // Подготовка аудио файлов
            await prepareAudioFiles();
            
            if (generationAborted) {
                finishGeneration();
                return;
            }
            
            // Генерация для каждого канала
            let channelIndex = 0;
            for (const channelId of selectedChannels) {
                if (generationAborted) break;
                
                const channel = channels.find(c => c.id === channelId);
                if (!channel) continue;
                
                channelIndex++;
                updateProgress(
                    (channelIndex / selectedChannels.size) * 100,
                    `Генерация для канала: ${channel.name}`
                );
                
                await generateChannelMontage(channel);
            }
            
            finishGeneration();
        }

        function finishGeneration() {
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('cancelButton').classList.remove('show');
            updateProgress(100, generationAborted ? "Генерация отменена" : "Генерация завершена!");
            log(generationAborted ? "Генерация отменена пользователем" : "Генерация завершена успешно", 
                generationAborted ? 'warning' : 'info');
        }

        function cancelGeneration() {
            if (confirm('Отменить генерацию?')) {
                generationAborted = true;
                log('Отмена генерации...', 'warning');
            }
        }

        async function prepareAudioFiles() {
            return new Promise((resolve) => {
                updateProgress(10, "Подготовка аудио файлов...");
                
                // Собираем уникальные настройки аудио из выбранных каналов
                const audioSettings = new Set();
                for (const channelId of selectedChannels) {
                    const channel = channels.find(c => c.id === channelId);
                    if (channel) {
                        const key = `${channel.effects.audioPitch}_${channel.effects.audioEffect}`;
                        audioSettings.add(key);
                    }
                }
                
                log(`Необходимо создать ${audioSettings.size} аудио вариантов`, 'info');
                
                const extScript = `
                    function prepareAudioVariants(folderPath, variants) {
                        try {
                            // Создаем папку для вариантов
                            var variantsFolder = new Folder(folderPath + "/audio_variants");
                            if (!variantsFolder.exists) variantsFolder.create();
                            
                            // Здесь должна быть обработка через FFmpeg
                            // В реальной версии вызывается bat файл
                            
                            return "SUCCESS: Аудио файлы подготовлены";
                        } catch(e) {
                            return "ERROR: " + e.toString();
                        }
                    }
                    
                    var variants = ${JSON.stringify(Array.from(audioSettings))};
                    prepareAudioVariants("${PROJECT_FOLDER.replace(/\\/g, '\\\\')}", variants);
                `;
                
                if (typeof CSInterface !== 'undefined') {
                    const csInterface = new CSInterface();
                    csInterface.evalScript(extScript, function(result) {
                        log(result, result.startsWith('SUCCESS') ? 'info' : 'error');
                        resolve();
                    });
                } else {
                    setTimeout(() => {
                        log("Аудио файлы подготовлены (симуляция)", 'info');
                        resolve();
                    }, 2000);
                }
            });
        }

        async function generateChannelMontage(channel) {
            return new Promise((resolve) => {
                log(`Создание монтажа для канала: ${channel.name}`, 'info');
                
                const config = {
                    channelName: channel.name,
                    template: EXPORT_PRESETS[channel.template],
                    effects: channel.effects,
                    projectFolder: PROJECT_FOLDER,
                    audioVariantsFolder: AUDIO_VARIANTS_FOLDER,
                    exportMode: document.getElementById('exportMode').value,
                    outputFormat: document.getElementById('outputFormat').value
                };
                
                const extScript = `
                    ${getMontageFunctions()}
                    
                    try {
                        var config = ${JSON.stringify(config)};
                        var result = createChannelMontage(config);
                        JSON.stringify(result);
                    } catch(e) {
                        JSON.stringify({success: false, error: e.toString()});
                    }
                `;
                
                if (typeof CSInterface !== 'undefined') {
                    const csInterface = new CSInterface();
                    csInterface.evalScript(extScript, function(result) {
                        try {
                            const response = JSON.parse(result);
                            if (response.success) {
                                log(`Монтаж для канала "${channel.name}" создан`, 'info');
                            } else {
                                log(`Ошибка создания монтажа: ${response.error}`, 'error');
                            }
                        } catch(e) {
                            log('Ошибка обработки результата', 'error');
                        }
                        resolve();
                    });
                } else {
                    setTimeout(() => {
                        log(`Монтаж для канала "${channel.name}" создан (симуляция)`, 'info');
                        resolve();
                    }, 3000);
                }
            });
        }

        function getMontageFunctions() {
            return `
                function createChannelMontage(config) {
                    var project = app.project;
                    if (!project) {
                        return {success: false, error: "Нет активного проекта"};
                    }
                    
                    try {
                        // Создаем секвенцию
                        var sequenceName = "Montage_" + config.channelName + "_" + new Date().getTime();
                        var sequence = project.createNewSequence(sequenceName, "");
                        
                        if (!sequence) {
                            return {success: false, error: "Не удалось создать секвенцию"};
                        }
                        
                        // Настраиваем параметры секвенции
                        sequence.name = sequenceName;
                        
                        // Здесь должна быть полная логика построения монтажа
                        // включая применение всех эффектов из config.effects
                        
                        return {success: true, sequenceName: sequenceName};
                        
                    } catch(e) {
                        return {success: false, error: e.toString()};
                    }
                }
            `;
        }

        // === НАСТРОЙКИ ===

        function loadSettings() {
            const stored = localStorage.getItem('autoMontageSettings');
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    
                    document.getElementById('ffmpegPath').value = settings.ffmpegPath || 'ffmpeg.exe';
                    document.getElementById('amePath').value = settings.amePath || '';
                    document.getElementById('renderThreads').value = settings.renderThreads || 4;
                    document.getElementById('renderThreadsValue').textContent = settings.renderThreads || 4;
                    document.getElementById('useGPU').checked = settings.useGPU !== false;
                    document.getElementById('useProxies').checked = settings.useProxies || false;
                    document.getElementById('transcodeRussian').checked = settings.transcodeRussian !== false;
                    document.getElementById('autoSave').checked = settings.autoSave !== false;
                    document.getElementById('keepSourceAudio').checked = settings.keepSourceAudio !== false;
                } catch(e) {
                    log('Ошибка загрузки настроек', 'warning');
                }
            }
        }

        function saveSettings() {
            const settings = {
                ffmpegPath: document.getElementById('ffmpegPath').value,
                amePath: document.getElementById('amePath').value,
                renderThreads: parseInt(document.getElementById('renderThreads').value),
                useGPU: document.getElementById('useGPU').checked,
                useProxies: document.getElementById('useProxies').checked,
                transcodeRussian: document.getElementById('transcodeRussian').checked,
                autoSave: document.getElementById('autoSave').checked,
                keepSourceAudio: document.getElementById('keepSourceAudio').checked
            };
            
            localStorage.setItem('autoMontageSettings', JSON.stringify(settings));
            log('Настройки сохранены', 'info');
        }

        function resetSettings() {
            if (confirm('Сбросить все настройки к значениям по умолчанию?')) {
                localStorage.removeItem('autoMontageSettings');
                loadSettings();
                log('Настройки сброшены', 'info');
            }
        }

        function browsePath(type) {
            if (typeof CSInterface !== 'undefined') {
                const csInterface = new CSInterface();
                
                let filter = type === 'ffmpeg' ? 'ffmpeg.exe' : 'Adobe Media Encoder.exe';
                let title = type === 'ffmpeg' ? 'Выберите ffmpeg.exe' : 'Выберите Adobe Media Encoder.exe';
                
                const extScript = `
                    var file = File.openDialog("${title}", "${filter}");
                    if (file) {
                        file.fsName;
                    } else {
                        null;
                    }
                `;
                
                csInterface.evalScript(extScript, function(result) {
                    if (result && result !== 'null') {
                        document.getElementById(`${type}Path`).value = result;
                        log(`Выбран путь ${type}: ${result}`, 'info');
                    }
                });
            } else {
                alert('Выбор файла доступен только в Premiere Pro');
            }
        }

        // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            
            // Очищаем поля
            if (modalId === 'channelModal') {
                document.getElementById('newChannelName').value = '';
                document.getElementById('newChannelDescription').value = '';
                document.getElementById('newChannelTemplate').value = 'YouTube';
            }
        }

        // Закрытие модальных окон по клику вне
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Автосохранение
        if (document.getElementById('autoSave')) {
            setInterval(() => {
                if (document.getElementById('autoSave').checked && typeof CSInterface !== 'undefined') {
                    const csInterface = new CSInterface();
                    csInterface.evalScript('app.project.save()', function() {
                        log('Автосохранение выполнено', 'info');
                    });
                }
            }, 300000); // каждые 5 минут
        }

        // Обработка ошибок
        window.addEventListener('error', function(e) {
            log(`Ошибка: ${e.message}`, 'error');
        });
    </script>

    <!-- CEP JavaScript API -->
    <script src="./js/CSInterface.js"></script>
</body>
</html>
